<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      padding: 20px;
      border-bottom: 1px solid #e8eaed;
      background-color: #1a73e8;
      color: white;
      border-radius: 8px 8px 0 0;
    }
    
    .header h2 {
      margin: 0;
      font-size: 18px;
    }
    
    .progress-section {
      padding: 20px;
      border-bottom: 1px solid #e8eaed;
    }
    
    .progress-bar-container {
      background-color: #e8eaed;
      border-radius: 4px;
      height: 8px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      background-color: #34a853;
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      font-size: 14px;
      color: #5f6368;
      margin-bottom: 5px;
    }
    
    .status-text {
      font-size: 16px;
      font-weight: 500;
      color: #202124;
      margin-bottom: 10px;
    }
    
    .results-section {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      max-height: 300px;
    }
    
    .result-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 4px;
      border-left: 4px solid;
      font-size: 14px;
    }
    
    .result-success {
      background-color: #e6f4ea;
      border-left-color: #34a853;
      color: #137333;
    }
    
    .result-error {
      background-color: #fce8e6;
      border-left-color: #ea4335;
      color: #d93025;
    }
    
    .result-warning {
      background-color: #fef7e0;
      border-left-color: #fbbc04;
      color: #e37400;
    }

    .result-duplicate {
      background-color: #fef7e0;
      border-left-color: #fbbc04;
      color: #e37400;
    }
    
    .result-processing {
      background-color: #e8f0fe;
      border-left-color: #1a73e8;
      color: #1557b0;
    }
    
    .row-number {
      font-weight: bold;
      margin-right: 8px;
    }
    
    .error-details {
      margin-top: 8px;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .record-link {
      color: #1a73e8;
      text-decoration: none;
      font-size: 12px;
      margin-top: 4px;
      display: block;
    }
    
    .record-link:hover {
      text-decoration: underline;
    }
    
    .footer {
      padding: 20px;
      border-top: 1px solid #e8eaed;
      text-align: center;
      background-color: #f8f9fa;
      border-radius: 0 0 8px 8px;
    }
    
    .close-btn {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 0 10px;
      transition: background-color 0.3s ease;
    }
    
    .close-btn:hover {
      background-color: #1557b0;
    }
    
    .close-btn:disabled {
      background-color: #dadce0;
      cursor: not-allowed;
    }

    .delete-btn {
        background-color: #ea4335;
    }

    .delete-btn:hover {
        background-color: #d93025;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .summary {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .summary-item {
      margin-bottom: 5px;
    }
    
    .summary-success {
      color: #137333;
    }
    
    .summary-error {
      color: #d93025;
    }
    
    .summary-warning {
      color: #e37400;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>üöÄ Sending Data to Zoho CRM</h2>
    </div>
    
    <div class="progress-section">
      <div class="status-text" id="statusText">Preparing to process rows...</div>
      <div class="progress-text" id="progressText">0 of 0 rows processed</div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>
    
    <div class="results-section" id="resultsSection">
      <div class="summary" id="summary" style="display: none;">
        <div class="summary-item summary-success" id="successCount">‚úÖ Successful: 0</div>
        <div class="summary-item summary-error" id="errorCount">‚ùå Failed: 0</div>
        <div class="summary-item summary-warning" id="warningCount">‚ö†Ô∏è Warnings: 0</div>
        <div class="summary-item summary-warning" id="duplicateCount">üóëÔ∏è Duplicates: 0</div>
      </div>
      <div id="resultsList"></div>
    </div>
    
    <div class="footer">
      <button onclick="deleteDuplicates()" class="close-btn delete-btn" id="deleteDuplicatesBtn" disabled>Delete Duplicates</button>
      <button onclick="closeDialog()" class="close-btn" id="closeBtn" disabled>Close</button>
    </div>
  </div>

  <script>
    let processingComplete = false;
    let results = [];
    let totalRows = 0;
    let processedRows = 0;
    let successCount = 0;
    let errorCount = 0;
    let warningCount = 0;
    let duplicateCount = 0;
    // This will hold the full duplicate info object for the new dialog
    let duplicateInfo = {};
    
    // Start processing when dialog loads
    window.onload = function() {
      startProcessing();
    };
    
    function startProcessing() {
      updateStatus('Getting rows to process...', false);
      
      google.script.run
        .withSuccessHandler(onRowsReceived)
        .withFailureHandler(onError)
        .getRowsToProcess();
    }
    
    function onRowsReceived(rows) {
      totalRows = rows.length;
      updateProgressText();
      
      if (totalRows === 0) {
        updateStatus('No unsubmitted rows found', true);
        
        // Show information about already processed rows
        google.script.run
          .withSuccessHandler(showIgnoredRowsInfo)
          .withFailureHandler(onError)
          .getProcessedRowsCount();
        
        enableCloseButton();
        return;
      }
      
      updateStatus('Checking for duplicates and processing ' + totalRows + ' unsubmitted rows...', false);
      
      // Start processing all rows
      google.script.run
        .withSuccessHandler(onProcessingComplete)
        .withFailureHandler(onError)
        .processAllRows();
      
      // Start polling for progress updates
      pollProgress();
    }
    
    function pollProgress() {
      // This is a simple progress simulation since we can't get real-time updates
      // from the server-side processing. In a real implementation, you might
      // process rows one by one with callbacks for real-time updates.
      
      if (!processingComplete) {
        setTimeout(pollProgress, 1000);
      }
    }
    
    function onProcessingComplete(data) {
      processingComplete = true;
      // The server now returns a complex object
      results = data.results;
      duplicateInfo = {
        unsubmittedDuplicateRows: data.unsubmittedDuplicateRows,
        topStats: data.duplicateStats.slice(0, 3)
      };
      
      // Reset counters
      successCount = 0;
      errorCount = 0;
      warningCount = 0;
      duplicateCount = 0;
      
      results.forEach(result => {
        if (result.isDuplicate) {
          duplicateCount++;
        }

        if (result.success) {
          successCount++;
          if (result.validationWarnings && result.validationWarnings.length > 0) {
            warningCount++;
          }
        } else {
          // All non-successes are counted as errors, including duplicates
          errorCount++;
        }
      });
      
      processedRows = results.length;
      
      // Update UI
      updateProgressText();
      updateProgressBar(100);
      updateStatus('Processing complete!', true);
      showSummary();
      displayResults();
      enableButtons();
    }
    
    function displayResults() {
      const resultsList = document.getElementById('resultsList');
      resultsList.innerHTML = '';
      
      results.forEach(result => {
        const resultItem = document.createElement('div');
        
        let content = `<span class="row-number">Row ${result.rowNumber}:</span>`;
        
        if (result.isDuplicate) {
          resultItem.className = 'result-item result-duplicate';
          content += `Marked as duplicate`;
          content += `<div class="error-details">This row has the same phone or email as another row.</div>`;
        } else if (result.success) {
          resultItem.className = 'result-item result-success';
          content += `Successfully sent to Zoho`;
          if (result.recordId) {
            content += `<a href="https://crm.zoho.com/crm/org820120607/tab/Leads/${result.recordId}" target="_blank" class="record-link">View in Zoho CRM</a>`;
          }
          if (result.validationWarnings && result.validationWarnings.length > 0) {
            content += `<div class="error-details">Warnings: ${result.validationWarnings.join(', ')}</div>`;
          }
        } else {
          resultItem.className = 'result-item result-error';
          content += `Failed to send`;
          if (result.error) {
            content += `<div class="error-details">${result.error}</div>`;
          } else if (result.validationErrors && result.validationErrors.length > 0) {
            content += `<div class="error-details">Validation errors: ${result.validationErrors.join(', ')}</div>`;
          }
        }
        
        resultItem.innerHTML = content;
        resultsList.appendChild(resultItem);
      });
    }
    
    function showSummary() {
      const summary = document.getElementById('summary');
      document.getElementById('successCount').textContent = `‚úÖ Successful: ${successCount}`;
      document.getElementById('errorCount').textContent = `‚ùå Failed: ${errorCount}`;
      document.getElementById('warningCount').textContent = `‚ö†Ô∏è Warnings: ${warningCount}`;
      document.getElementById('duplicateCount').textContent = `üóëÔ∏è Duplicates: ${duplicateCount}`;
      summary.style.display = 'block';
    }
    
    function updateStatus(text, complete) {
      const statusElement = document.getElementById('statusText');
      if (complete) {
        statusElement.innerHTML = text;
      } else {
        statusElement.innerHTML = `<span class="spinner"></span>${text}`;
      }
    }
    
    function updateProgressText() {
      document.getElementById('progressText').textContent = `${processedRows} of ${totalRows} rows processed`;
    }
    
    function updateProgressBar(percentage) {
      document.getElementById('progressBar').style.width = percentage + '%';
    }
    
    function enableButtons() {
      document.getElementById('closeBtn').disabled = false;
      // Enable button if there are any unsubmitted duplicates to delete
      if (duplicateInfo.unsubmittedDuplicateRows && duplicateInfo.unsubmittedDuplicateRows.length > 0) {
        document.getElementById('deleteDuplicatesBtn').disabled = false;
      }
    }
    
    function enableCloseButton() {
      document.getElementById('closeBtn').disabled = false;
    }

    function deleteDuplicates() {
      if (!duplicateInfo.unsubmittedDuplicateRows || duplicateInfo.unsubmittedDuplicateRows.length === 0) {
        alert("No unsubmitted duplicates to delete.");
        return;
      }

      // Instead of confirm(), call the new server-side function to show the rich dialog
      google.script.run
        .withSuccessHandler(function() {
          // The dialog is now open. This dialog will close, but the new one will appear.
          // We can close this dialog for a cleaner experience.
          google.script.host.close();
        })
        .withFailureHandler(onError)
        .showDuplicateDialogWithData(duplicateInfo);
    }
    
    function showIgnoredRowsInfo(rowCounts) {
      const resultsList = document.getElementById('resultsList');
      
      if (rowCounts.totalDataRows > 0) {
        const infoItem = document.createElement('div');
        infoItem.className = 'result-item result-processing';
        infoItem.innerHTML = `
          <span class="row-number">‚ÑπÔ∏è Summary:</span>
          Found ${rowCounts.totalDataRows} total data rows. 
          ${rowCounts.processedCount} rows have already been processed and were ignored.
        `;
        resultsList.appendChild(infoItem);
      } else {
        const infoItem = document.createElement('div');
        infoItem.className = 'result-item result-processing';
        infoItem.innerHTML = `<span class="row-number">‚ÑπÔ∏è Info:</span> No data rows found in the spreadsheet.`;
        resultsList.appendChild(infoItem);
      }
    }
    
    function onError(error) {
      processingComplete = true;
      updateStatus('Error: ' + error.message, true);
      enableCloseButton();
      
      const resultsList = document.getElementById('resultsList');
      const errorItem = document.createElement('div');
      errorItem.className = 'result-item result-error';
      errorItem.innerHTML = `<span class="row-number">System Error:</span> ${error.message}`;
      resultsList.appendChild(errorItem);
    }
    
    
    function closeDialog() {
      google.script.host.close();
    }
  </script>
</body>
</html>