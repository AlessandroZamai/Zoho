<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      padding: 15px 20px;
      border-bottom: 1px solid #e8eaed;
      background-color: #1a73e8;
      color: white;
      border-radius: 8px 8px 0 0;
    }
    
    .header h2 {
      margin: 0;
      font-size: 18px;
    }
    
    .progress-section {
      padding: 15px 20px;
      border-bottom: 1px solid #e8eaed;
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .metric {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .metric-label {
      color: #5f6368;
      display: block;
      margin-bottom: 4px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .metric-value {
      color: #202124;
      font-weight: 600;
      font-size: 16px;
    }
    
    .progress-bar-container {
      background-color: #e8eaed;
      border-radius: 4px;
      height: 8px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      background-color: #34a853;
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .progress-bar.paused {
      background-color: #fbbc04;
    }
    
    .progress-text {
      font-size: 14px;
      color: #5f6368;
      margin-bottom: 5px;
    }
    
    .status-text {
      font-size: 16px;
      font-weight: 500;
      color: #202124;
      margin-bottom: 10px;
    }
    
    .control-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .control-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.3s ease;
    }
    
    .pause-btn {
      background-color: #fbbc04;
      color: #202124;
    }
    
    .pause-btn:hover {
      background-color: #f9ab00;
    }
    
    .resume-btn {
      background-color: #34a853;
      color: white;
    }
    
    .resume-btn:hover {
      background-color: #2d9348;
    }
    
    .control-btn:disabled {
      background-color: #dadce0;
      cursor: not-allowed;
      color: #5f6368;
    }
    
    .results-section {
      flex: 1;
      padding: 15px 20px;
      overflow-y: auto;
      max-height: 250px;
    }
    
    .result-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 4px;
      border-left: 4px solid;
      font-size: 14px;
    }
    
    .result-success {
      background-color: #e6f4ea;
      border-left-color: #34a853;
      color: #137333;
    }
    
    .result-error {
      background-color: #fce8e6;
      border-left-color: #ea4335;
      color: #d93025;
    }
    
    .result-warning {
      background-color: #fef7e0;
      border-left-color: #fbbc04;
      color: #e37400;
    }

    .result-duplicate {
      background-color: #fef7e0;
      border-left-color: #fbbc04;
      color: #e37400;
    }
    
    .result-processing {
      background-color: #e8f0fe;
      border-left-color: #1a73e8;
      color: #1557b0;
    }
    
    .row-number {
      font-weight: bold;
      margin-right: 8px;
    }
    
    .error-details {
      margin-top: 8px;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .footer {
      padding: 20px;
      border-top: 1px solid #e8eaed;
      text-align: center;
      background-color: #f8f9fa;
      border-radius: 0 0 8px 8px;
    }
    
    .close-btn {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 0 10px;
      transition: background-color 0.3s ease;
    }
    
    .close-btn:hover {
      background-color: #1557b0;
    }
    
    .close-btn:disabled {
      background-color: #dadce0;
      cursor: not-allowed;
    }

    .delete-btn {
        background-color: #ea4335;
    }

    .delete-btn:hover {
        background-color: #d93025;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .summary {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .summary-item {
      margin-bottom: 5px;
    }
    
    .summary-success {
      color: #137333;
    }
    
    .summary-error {
      color: #d93025;
    }
    
    .summary-warning {
      color: #e37400;
    }
    
    .resume-notice {
      background-color: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      border-left: 4px solid #1a73e8;
    }
    
    .resume-notice-title {
      font-weight: 600;
      color: #1557b0;
      margin-bottom: 8px;
    }
    
    .resume-notice-text {
      color: #5f6368;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>üöÄ Sending Data to Zoho CRM</h2>
    </div>
    
    <div class="progress-section">
      <div class="status-text" id="statusText">Preparing to process rows...</div>
      <div class="progress-text" id="progressText">0 of 0 rows processed</div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      
      <div class="metrics-grid" id="metricsGrid" style="display: none;">
        <div class="metric">
          <span class="metric-label">Elapsed Time</span>
          <span class="metric-value" id="elapsedTime">00:00</span>
        </div>
        <div class="metric">
          <span class="metric-label">Est. Time</span>
          <span class="metric-value" id="estimatedTime">-</span>
        </div>
      </div>
      
      <div class="control-buttons" id="controlButtons" style="display: none;">
        <button onclick="handlePause()" class="control-btn pause-btn" id="pauseBtn">‚è∏ Pause</button>
        <button onclick="handleResume()" class="control-btn resume-btn" id="resumeBtn" style="display: none;">‚ñ∂ Resume</button>
      </div>
      
      <div class="control-buttons" id="clearProgressButtons" style="display: none; margin-top: 10px;">
        <button onclick="handleClearProgress()" class="control-btn" id="clearProgressBtn" style="background-color: #ea4335; color: white;">üóëÔ∏è Clear Saved Progress</button>
      </div>
    </div>
    
    <div class="results-section" id="resultsSection">
      <div id="resumeNotice" style="display: none;" class="resume-notice">
        <div class="resume-notice-title">üìã Previous Session Found</div>
        <div class="resume-notice-text" id="resumeNoticeText"></div>
      </div>
      <div class="summary" id="summary" style="display: none;">
        <div class="summary-item summary-success" id="successCount">‚úÖ Successful: 0</div>
        <div class="summary-item summary-error" id="errorCount">‚ùå Failed: 0</div>
        <div class="summary-item summary-warning" id="warningCount">‚ö†Ô∏è Warnings: 0</div>
        <div class="summary-item summary-warning" id="duplicateCount">üóëÔ∏è Duplicates: 0</div>
        <div class="summary-item" id="totalTime" style="color: #5f6368; margin-top: 10px;">‚è±Ô∏è Total Time: -</div>
      </div>
      <div id="resultsList"></div>
    </div>
    
    <div class="footer">
      <button onclick="deleteDuplicates()" class="close-btn delete-btn" id="deleteDuplicatesBtn" disabled>Delete Duplicates</button>
      <button onclick="closeDialog()" class="close-btn" id="closeBtn" disabled>Close</button>
    </div>
  </div>

  <script>
    const BATCH_SIZE = 200;
    
    let processingComplete = false;
    let processingPaused = false;
    let processingStartTime = null;
    let results = [];
    let totalRows = 0;
    let processedRows = 0;
    let currentBatchIndex = 0;
    let successCount = 0;
    let errorCount = 0;
    let warningCount = 0;
    let duplicateCount = 0;
    let duplicateInfo = {};
    let metricsInterval = null;
    
    window.onload = function() {
      checkForSavedProgress();
    };
    
    function checkForSavedProgress() {
      updateStatus('Checking for previous session...', false);
      
      google.script.run
        .withSuccessHandler(onSavedProgressChecked)
        .withFailureHandler(onError)
        .getSavedProgress();
    }
    
    function onSavedProgressChecked(progress) {
      if (progress && progress.processedCount > 0) {
        showResumeNotice(progress);
        document.getElementById('clearProgressButtons').style.display = 'flex';
        setTimeout(() => startProcessing(progress.processedCount), 500);
      } else {
        startProcessing(0);
      }
    }
    
    function showResumeNotice(progress) {
      const notice = document.getElementById('resumeNotice');
      const noticeText = document.getElementById('resumeNoticeText');
      
      noticeText.innerHTML = `
        Found previous session with ${progress.processedCount} rows processed 
        (${progress.successCount} successful, ${progress.errorCount} failed, ${progress.duplicateCount} duplicates).
        <br><strong>Resuming from row ${progress.processedCount + 1}...</strong>
      `;
      
      notice.style.display = 'block';
      
      results = progress.results || [];
      successCount = progress.successCount || 0;
      errorCount = progress.errorCount || 0;
      duplicateCount = progress.duplicateCount || 0;
      processedRows = progress.processedCount || 0;
    }
    
    function startProcessing(startIndex = 0) {
      updateStatus('Getting rows to process...', false);
      
      google.script.run
        .withSuccessHandler((rows) => onRowsReceived(rows, startIndex))
        .withFailureHandler(onError)
        .getRowsToProcess();
    }
    
    function onRowsReceived(rows, startIndex) {
      totalRows = rows.length;
      currentBatchIndex = startIndex;
      
      // Only set processing start time if starting fresh (not resuming)
      if (!processingStartTime && startIndex === 0) {
        processingStartTime = new Date().getTime();
      }
      
      // Hide resume notice when starting/resuming processing
      document.getElementById('resumeNotice').style.display = 'none';
      
      updateProgressText();
      
      if (totalRows === 0) {
        updateStatus('No unsubmitted rows found', true);
        google.script.run
          .withSuccessHandler(showIgnoredRowsInfo)
          .withFailureHandler(onError)
          .getProcessedRowsCount();
        enableCloseButton();
        return;
      }
      
      if (currentBatchIndex >= totalRows) {
        updateStatus('All rows already processed', true);
        enableCloseButton();
        return;
      }
      
      updateStatus(`Processing ${totalRows} rows in batches of ${BATCH_SIZE}...`, false);
      
      document.getElementById('metricsGrid').style.display = 'grid';
      document.getElementById('controlButtons').style.display = 'flex';
      
      // Start metrics update interval
      if (!metricsInterval) {
        metricsInterval = setInterval(updateMetrics, 500);
      }
      
      // Initial metrics update
      updateMetrics();
      
      processNextBatch();
    }
    
    function processNextBatch() {
      if (processingPaused) {
        updateStatus('Processing paused - Click Resume to continue', true);
        document.getElementById('progressBar').classList.add('paused');
        return;
      }
      
      if (currentBatchIndex >= totalRows) {
        onAllBatchesComplete();
        return;
      }
      
      updateStatus(`Processing batch starting at row ${currentBatchIndex + 1}...`, false);
      
      google.script.run
        .withSuccessHandler(onBatchComplete)
        .withFailureHandler(onError)
        .processRowBatch(currentBatchIndex, BATCH_SIZE);
    }
    
    function onBatchComplete(batchResult) {
      if (batchResult.paused) {
        processingPaused = true;
        document.getElementById('pauseBtn').style.display = 'none';
        document.getElementById('resumeBtn').style.display = 'block';
        updateStatus('Processing paused', true);
        return;
      }
      
      results.push(...batchResult.results);
      currentBatchIndex = batchResult.nextIndex;
      processedRows = batchResult.processedCount;
      
      batchResult.results.forEach(result => {
        if (result.isDuplicate) {
          duplicateCount++;
        } else if (result.success) {
          successCount++;
          if (result.validationWarnings && result.validationWarnings.length > 0) {
            warningCount++;
          }
        } else {
          errorCount++;
        }
      });
      
      updateProgressText();
      updateProgressBar((processedRows / totalRows) * 100);
      updateMetrics(); // Update metrics immediately after batch completion
      
      if (batchResult.hasMore) {
        setTimeout(processNextBatch, 100);
      } else {
        onAllBatchesComplete();
      }
    }
    
    function onAllBatchesComplete() {
      processingComplete = true;
      
      if (metricsInterval) {
        clearInterval(metricsInterval);
      }
      
      updateMetrics();
      updateProgressBar(100);
      updateStatus('Processing complete!', true);
      
      google.script.run
        .withSuccessHandler((cache) => {
          if (cache && cache.duplicateStats) {
            duplicateInfo = {
              unsubmittedDuplicateRows: cache.unsubmittedDuplicateRows || [],
              topStats: (cache.duplicateStats || []).slice(0, 3)
            };
          }
          
          const totalTime = (new Date().getTime() - processingStartTime) / 1000;
          showSummary(totalTime);
          displayResults();
          enableButtons();
          
          google.script.run.clearSavedProgress();
        })
        .withFailureHandler(() => {
          const totalTime = (new Date().getTime() - processingStartTime) / 1000;
          showSummary(totalTime);
          displayResults();
          enableButtons();
        })
        .getSavedProgress();
    }
    
    function handlePause() {
      processingPaused = true;
      document.getElementById('pauseBtn').disabled = true;
      
      // Stop the metrics interval when pausing
      if (metricsInterval) {
        clearInterval(metricsInterval);
        metricsInterval = null;
      }
      
      google.script.run
        .withSuccessHandler(() => {
          document.getElementById('pauseBtn').style.display = 'none';
          document.getElementById('resumeBtn').style.display = 'block';
          document.getElementById('resumeBtn').disabled = false;
          updateStatus('Processing paused - Click Resume to continue', true);
          document.getElementById('progressBar').classList.add('paused');
        })
        .withFailureHandler(onError)
        .pauseProcessing();
    }
    
    function handleResume() {
      document.getElementById('resumeBtn').disabled = true;
      
      google.script.run
        .withSuccessHandler(() => {
          processingPaused = false;
          document.getElementById('resumeBtn').style.display = 'none';
          document.getElementById('pauseBtn').style.display = 'block';
          document.getElementById('pauseBtn').disabled = false;
          document.getElementById('progressBar').classList.remove('paused');
          document.getElementById('clearProgressButtons').style.display = 'none';
          updateStatus('Resuming processing...', false);
          
          // Set processing start time when resume button is pressed
          if (!processingStartTime) {
            processingStartTime = new Date().getTime();
          }
          
          // Restart the metrics interval when resuming
          if (!metricsInterval) {
            metricsInterval = setInterval(updateMetrics, 500);
          }
          
          processNextBatch();
        })
        .withFailureHandler((error) => {
          document.getElementById('resumeBtn').disabled = false;
          const errorMsg = error && error.message ? error.message : (typeof error === 'string' ? error : 'Unknown error occurred');
          updateStatus('Error resuming: ' + errorMsg, true);
          
          const resultsList = document.getElementById('resultsList');
          const errorItem = document.createElement('div');
          errorItem.className = 'result-item result-error';
          errorItem.innerHTML = `<span class="row-number">Resume Error:</span> ${errorMsg}`;
          resultsList.appendChild(errorItem);
        })
        .resumeProcessing();
    }
    
    function updateMetrics() {
      if (!processingStartTime) return;
      
      const elapsed = (new Date().getTime() - processingStartTime) / 1000;
      const remainingRows = totalRows - processedRows;
      const estimatedTime = remainingRows * 2.5; // Static estimate: 2.5 seconds per remaining row
      
      document.getElementById('elapsedTime').textContent = formatTime(elapsed);
      document.getElementById('estimatedTime').textContent = formatTime(estimatedTime);
    }
    
    function formatTime(seconds) {
      if (!isFinite(seconds) || seconds < 0) return '-';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    function displayResults() {
      const resultsList = document.getElementById('resultsList');
      resultsList.innerHTML = '';
      
      const problemResults = results.filter(r => 
        !r.success || r.isDuplicate || (r.validationWarnings && r.validationWarnings.length > 0)
      );
      
      if (problemResults.length === 0) {
        const successMsg = document.createElement('div');
        successMsg.className = 'result-item result-success';
        successMsg.innerHTML = '<span class="row-number">‚úÖ</span>All rows processed successfully with no errors or warnings!';
        resultsList.appendChild(successMsg);
        return;
      }
      
      problemResults.forEach(result => {
        const resultItem = document.createElement('div');
        let content = `<span class="row-number">Row ${result.rowNumber}:</span>`;
        
        if (result.isDuplicate) {
          resultItem.className = 'result-item result-duplicate';
          content += `Marked as duplicate`;
          content += `<div class="error-details">This row has the same phone or email as another row.</div>`;
        } else if (result.success && result.validationWarnings && result.validationWarnings.length > 0) {
          resultItem.className = 'result-item result-warning';
          content += `Sent with warnings`;
          content += `<div class="error-details">Warnings: ${result.validationWarnings.join(', ')}</div>`;
        } else {
          resultItem.className = 'result-item result-error';
          content += `Failed to send`;
          if (result.error) {
            content += `<div class="error-details">${result.error}</div>`;
          } else if (result.validationErrors && result.validationErrors.length > 0) {
            content += `<div class="error-details">Validation errors: ${result.validationErrors.join(', ')}</div>`;
          }
        }
        
        resultItem.innerHTML = content;
        resultsList.appendChild(resultItem);
      });
    }
    
    function showSummary(processingTime) {
      const summary = document.getElementById('summary');
      document.getElementById('successCount').textContent = `‚úÖ Successful: ${successCount}`;
      document.getElementById('errorCount').textContent = `‚ùå Failed: ${errorCount}`;
      document.getElementById('warningCount').textContent = `‚ö†Ô∏è Warnings: ${warningCount}`;
      document.getElementById('duplicateCount').textContent = `üóëÔ∏è Duplicates: ${duplicateCount}`;
      
      if (processingTime) {
        document.getElementById('totalTime').textContent = `‚è±Ô∏è Total Time: ${formatTime(processingTime)}`;
      }
      
      summary.style.display = 'block';
    }
    
    function updateStatus(text, complete) {
      const statusElement = document.getElementById('statusText');
      if (complete) {
        statusElement.innerHTML = text;
      } else {
        statusElement.innerHTML = `<span class="spinner"></span>${text}`;
      }
    }
    
    function updateProgressText() {
      document.getElementById('progressText').textContent = `${processedRows} of ${totalRows} rows processed`;
    }
    
    function updateProgressBar(percentage) {
      document.getElementById('progressBar').style.width = percentage + '%';
    }
    
    function enableButtons() {
      document.getElementById('closeBtn').disabled = false;
      if (duplicateInfo.unsubmittedDuplicateRows && duplicateInfo.unsubmittedDuplicateRows.length > 0) {
        document.getElementById('deleteDuplicatesBtn').disabled = false;
      }
      document.getElementById('controlButtons').style.display = 'none';
      
      // Hide metrics and clear progress button when complete
      document.getElementById('metricsGrid').style.display = 'none';
      document.getElementById('clearProgressButtons').style.display = 'none';
      
      // Move summary to top of results section
      const resultsSection = document.getElementById('resultsSection');
      const summary = document.getElementById('summary');
      if (summary && resultsSection) {
        resultsSection.insertBefore(summary, resultsSection.firstChild);
      }
    }
    
    function enableCloseButton() {
      document.getElementById('closeBtn').disabled = false;
    }

    function deleteDuplicates() {
      if (!duplicateInfo.unsubmittedDuplicateRows || duplicateInfo.unsubmittedDuplicateRows.length === 0) {
        alert("No unsubmitted duplicates to delete.");
        return;
      }

      google.script.run
        .withSuccessHandler(function() {
          google.script.host.close();
        })
        .withFailureHandler(onError)
        .showDuplicateDialogWithData(duplicateInfo);
    }
    
    function showIgnoredRowsInfo(rowCounts) {
      const resultsList = document.getElementById('resultsList');
      
      if (rowCounts.totalDataRows > 0) {
        const infoItem = document.createElement('div');
        infoItem.className = 'result-item result-processing';
        infoItem.innerHTML = `
          <span class="row-number">‚ÑπÔ∏è Summary:</span>
          Found ${rowCounts.totalDataRows} total data rows. 
          ${rowCounts.processedCount} rows have already been processed and were ignored.
        `;
        resultsList.appendChild(infoItem);
      } else {
        const infoItem = document.createElement('div');
        infoItem.className = 'result-item result-processing';
        infoItem.innerHTML = `<span class="row-number">‚ÑπÔ∏è Info:</span> No data rows found in the spreadsheet.`;
        resultsList.appendChild(infoItem);
      }
    }
    
    function onError(error) {
      processingComplete = true;
      
      if (metricsInterval) {
        clearInterval(metricsInterval);
      }
      
      const errorMsg = error && error.message ? error.message : (typeof error === 'string' ? error : 'Unknown error occurred');
      updateStatus('Error: ' + errorMsg, true);
      enableCloseButton();
      
      const resultsList = document.getElementById('resultsList');
      const errorItem = document.createElement('div');
      errorItem.className = 'result-item result-error';
      errorItem.innerHTML = `<span class="row-number">System Error:</span> ${errorMsg}`;
      resultsList.appendChild(errorItem);
    }
    
    function handleClearProgress() {
      if (!confirm('Are you sure you want to clear saved progress? This will start fresh from the beginning.')) {
        return;
      }
      
      document.getElementById('clearProgressBtn').disabled = true;
      updateStatus('Clearing saved progress...', false);
      
      google.script.run
        .withSuccessHandler(() => {
          document.getElementById('resumeNotice').style.display = 'none';
          document.getElementById('clearProgressButtons').style.display = 'none';
          
          // Reset all counters
          results = [];
          successCount = 0;
          errorCount = 0;
          warningCount = 0;
          duplicateCount = 0;
          processedRows = 0;
          currentBatchIndex = 0;
          
          // Reset processing timer
          if (metricsInterval) {
            clearInterval(metricsInterval);
            metricsInterval = null;
          }
          processingStartTime = null;
          
          updateStatus('Saved progress cleared. Starting fresh...', false);
          
          // Start processing from beginning
          setTimeout(() => startProcessing(0), 1000);
        })
        .withFailureHandler((error) => {
          document.getElementById('clearProgressBtn').disabled = false;
          alert('Error clearing progress: ' + error.message);
        })
        .clearSavedProgress();
    }
    
    function closeDialog() {
      google.script.host.close();
    }
  </script>
</body>
</html>
