<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 0 auto;
    }
    
    h2 {
      color: #1a73e8;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .step {
      display: none;
    }
    
    .step.active {
      display: block;
    }
    
    .progress-bar {
      background-color: #e8eaed;
      height: 4px;
      border-radius: 2px;
      margin-bottom: 30px;
      overflow: hidden;
    }
    
    .progress-fill {
      background-color: #1a73e8;
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .step-title {
      font-size: 18px;
      font-weight: 600;
      color: #202124;
      margin-bottom: 15px;
    }
    
    .description {
      margin-bottom: 25px;
      color: #5f6368;
      line-height: 1.5;
    }
    
    .option {
      border: 2px solid #e8eaed;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .option:hover {
      border-color: #1a73e8;
      background-color: #f8f9ff;
    }
    
    .option.selected {
      border-color: #1a73e8;
      background-color: #e8f0fe;
    }
    
    .option-title {
      font-weight: bold;
      color: #202124;
      margin-bottom: 8px;
    }
    
    .option-description {
      color: #5f6368;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-weight: 500;
      color: #202124;
      margin-bottom: 8px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e8eaed;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #1a73e8;
    }
    
    .date-input {
      width: 48%;
      display: inline-block;
    }
    
    .date-input:first-child {
      margin-right: 4%;
    }
    
    .buttons {
      text-align: center;
      margin-top: 25px;
    }
    
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 0 10px;
      transition: background-color 0.3s ease;
    }
    
    button:hover {
      background-color: #1557b0;
    }
    
    button:disabled {
      background-color: #dadce0;
      cursor: not-allowed;
    }
    
    .secondary-btn {
      background-color: #5f6368;
    }
    
    .secondary-btn:hover {
      background-color: #3c4043;
    }
    
    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
      display: none;
    }
    
    .status.success {
      background-color: #e6f4ea;
      color: #137333;
      border: 1px solid #34a853;
    }
    
    .status.error {
      background-color: #fce8e6;
      color: #d93025;
      border: 1px solid #ea4335;
    }
    
    .loading {
      display: none;
      text-align: center;
      margin-top: 15px;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .info-box {
      background-color: #e8f0fe;
      border: 1px solid #1a73e8;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .info-box-title {
      font-weight: 600;
      color: #1a73e8;
      margin-bottom: 8px;
    }
    
    .info-box-text {
      color: #1557b0;
      font-size: 14px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Zoho Integration Setup</h2>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <!-- Step 1: Processing Mode -->
    <div class="step active" id="step1">
      <div class="step-title">Step 1: Processing Mode</div>
      <div class="description">
        Choose how you want to process data for Zoho CRM:
      </div>
      
      <div class="option" data-mode="MANUAL" onclick="selectProcessingMode('MANUAL')">
        <div class="option-title">üëÜ Manual Processing</div>
        <div class="option-description">
          Data is sent to Zoho only when you click the "Send to Zoho" menu button. 
          Includes a progress dialog and detailed error reporting. Best for manual data entry.
        </div>
      </div>
      
      <div class="option" data-mode="AUTO" onclick="selectProcessingMode('AUTO')">
        <div class="option-title">üîÑ Automated Change Monitoring</div>
        <div class="option-description">
          Data is automatically sent to Zoho when you edit any cell in the spreadsheet. 
          Best for automated workflows where data is added without user intervention.
        </div>
      </div>
    </div>
    
    <!-- Step 2: Organization Type -->
    <div class="step" id="step2">
      <div class="step-title">Step 2: Organization Type</div>
      <div class="description">
        Select your organization type to configure the appropriate settings:
      </div>
      
      <div class="option" data-org="KI" onclick="selectOrganization('KI')">
        <div class="option-title">üè¢ Corporate Store</div>
        <div class="option-description">
          TELUS corporate-owned stores with predefined integration settings.
        </div>
      </div>
      
      <div class="option" data-org="DL" onclick="selectOrganization('DL')">
        <div class="option-title">ü§ù Dealership</div>
        <div class="option-description">
          Independent dealer partners who manage their own integration credentials.
        </div>
      </div>
      
      <div class="option" data-org="RT" onclick="selectOrganization('RT')">
        <div class="option-title">üì± Mobile Klinik</div>
        <div class="option-description">
          Mobile Klinik locations with predefined integration settings.
        </div>
      </div>
    </div>
    
    <!-- Step 2: Credentials (Dealership only) -->
    <div class="step" id="step2">
      <div class="step-title">Step 2: Integration Credentials</div>
      <div class="description">
        Enter your dealership's Zoho integration credentials:
      </div>
      
      <div class="form-group">
        <label class="form-label" for="orgCode">Organization Code</label>
        <input type="text" id="orgCode" class="form-input" placeholder="Enter your 4 or 5-digit organization code">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="authTokenName">Auth Token Name</label>
        <input type="text" id="authTokenName" class="form-input" placeholder="Enter your auth token name">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="authTokenValue">Auth Token Value</label>
        <input type="password" id="authTokenValue" class="form-input" placeholder="Enter your auth token value">
      </div>
    </div>
    
    <!-- Step 3: Campaign Dates -->
    <div class="step" id="step3">
      <div class="step-title">Step 3: Campaign Dates</div>
      <div class="description">
        Set the start and end dates for your campaign:
      </div>
      
      <div class="form-group">
        <div class="date-input">
          <label class="form-label" for="startDate">Campaign Start Date</label>
          <input type="date" id="startDate" class="form-input">
        </div>
        <div class="date-input">
          <label class="form-label" for="endDate">Campaign End Date</label>
          <input type="date" id="endDate" class="form-input">
        </div>
      </div>
    </div>
    
    <!-- Step 4: Lead Assignment -->
    <div class="step" id="step4">
      <div class="step-title">Step 4: Lead Assignment</div>
      <div class="description" id="assignmentDescription">
        Choose how leads should be assigned:
      </div>
      
      <!-- Corporate Store / Mobile Klinik Options -->
      <div id="storeAssignmentOptions" style="display: none;">
        <div class="option" data-assignment="EQUAL" onclick="selectAssignment('EQUAL')">
          <div class="option-title">‚öñÔ∏è Equal Distribution</div>
          <div class="option-description">
            Distribute leads equally among all store employees. You'll enter the store's 11-digit Channel Outlet ID.
          </div>
        </div>
        
        <div class="option" data-assignment="MANUAL" onclick="selectAssignment('MANUAL')">
          <div class="option-title">üë§ Manual Assignment</div>
          <div class="option-description">
            Manually assign each lead to a specific sales representative by entering their email address.
          </div>
        </div>
      </div>
      
      <!-- Dealership Options -->
      <div id="dealerAssignmentOptions" style="display: none;">
        <div class="option" data-assignment="ADMIN" onclick="selectAssignment('ADMIN')">
          <div class="option-title">üë®‚Äçüíº Dealer Admin</div>
          <div class="option-description">
            Assign all leads to the dealer administrator automatically.
          </div>
        </div>
        
        <div class="option" data-assignment="MANUAL" onclick="selectAssignment('MANUAL')">
          <div class="option-title">üë§ Manual Assignment</div>
          <div class="option-description">
            Manually assign each lead to a specific sales representative by entering their email address.
          </div>
        </div>
      </div>
      
      <div class="info-box" id="assignmentInfo" style="display: none;">
        <div class="info-box-title" id="infoTitle"></div>
        <div class="info-box-text" id="infoText"></div>
      </div>
    </div>
    
    <!-- Step 5: Trigger Mode -->
    <div class="step" id="step5">
      <div class="step-title">Step 5: Trigger Mode</div>
      <div class="description">
        Choose how you want to trigger data submission to Zoho CRM:
      </div>
      
      <div class="option" data-mode="AUTO" onclick="selectTriggerMode('AUTO')">
        <div class="option-title">üîÑ Automated Trigger</div>
        <div class="option-description">
          Data is automatically sent to Zoho when you edit any cell in the spreadsheet. 
          Best for automated workflows where data is added without user intervention.
        </div>
      </div>
      
      <div class="option" data-mode="MANUAL" onclick="selectTriggerMode('MANUAL')">
        <div class="option-title">üëÜ Manual Trigger</div>
        <div class="option-description">
          Data is sent to Zoho only when you click the "Send to Zoho" menu button. 
          Includes a progress dialog and detailed error reporting. Best for manual data entry.
        </div>
      </div>
    </div>
    
    <!-- Navigation Buttons -->
    <div class="buttons">
      <button onclick="previousStep()" id="prevBtn" class="secondary-btn" style="display: none;">Previous</button>
      <button onclick="nextStep()" id="nextBtn" disabled>Next</button>
      <button onclick="saveConfiguration()" id="saveBtn" style="display: none;">Save Configuration</button>
      <button onclick="google.script.host.close()" class="secondary-btn">Cancel</button>
    </div>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      Configuring integration...
    </div>
    
    <div class="status" id="status"></div>
  </div>

  <script>
    let currentStep = 1;
    let totalSteps = 6;
    let config = {
      processingMode: null,
      organizationType: null,
      orgCode: null,
      authTokenName: null,
      authTokenValue: null,
      campaignStartDate: null,
      campaignEndDate: null,
      leadAssignment: null
    };
    
    // Initialize dates
    window.onload = function() {
      const today = new Date();
      const endDate = new Date(today);
      endDate.setDate(endDate.getDate() + 30);
      
      document.getElementById('startDate').value = today.toISOString().split('T')[0];
      document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
      
      updateProgress();
      loadExistingConfiguration();
    };
    
    function loadExistingConfiguration() {
      google.script.run
        .withSuccessHandler(function(existingConfig) {
          if (existingConfig) {
            // Load existing configuration
            if (existingConfig.processingMode) {
              selectProcessingMode(existingConfig.processingMode);
            }
            if (existingConfig.organizationType) {
              selectOrganization(existingConfig.organizationType);
            }
            // Load other fields as needed
          }
        })
        .getExistingConfiguration();
    }
    
    function selectProcessingMode(mode) {
      // Remove previous selections
      document.querySelectorAll('[data-mode]').forEach(option => {
        option.classList.remove('selected');
      });
      
      // Add selection
      document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
      config.processingMode = mode;
      
      updateNextButton();
    }
    
    function selectOrganization(orgType) {
      // Remove previous selections
      document.querySelectorAll('[data-org]').forEach(option => {
        option.classList.remove('selected');
      });
      
      // Add selection
      document.querySelector(`[data-org="${orgType}"]`).classList.add('selected');
      config.organizationType = orgType;
      
      // Adjust total steps based on organization type
      if (orgType === 'DL') {
        totalSteps = 6; // Include credentials step
      } else {
        totalSteps = 5; // Skip credentials step
      }
      
      updateNextButton();
    }
    
    function selectAssignment(assignmentType) {
      // Remove previous selections
      document.querySelectorAll('[data-assignment]').forEach(option => {
        option.classList.remove('selected');
      });
      
      // Add selection
      document.querySelector(`[data-assignment="${assignmentType}"]`).classList.add('selected');
      config.leadAssignment = assignmentType;
      
      // Show info box
      const infoBox = document.getElementById('assignmentInfo');
      const infoTitle = document.getElementById('infoTitle');
      const infoText = document.getElementById('infoText');
      
      if (assignmentType === 'EQUAL') {
        infoTitle.textContent = 'Column Configuration';
        infoText.textContent = 'Column 17 (ChannelOutletID) will be enabled for entering store codes. Column 18 (AssigntoSalesRepEmail) will be disabled.';
      } else if (assignmentType === 'MANUAL') {
        infoTitle.textContent = 'Column Configuration';
        infoText.textContent = 'Column 18 (AssigntoSalesRepEmail) will be enabled for entering sales rep emails. Column 17 (ChannelOutletID) will be disabled.';
      } else if (assignmentType === 'ADMIN') {
        infoTitle.textContent = 'Column Configuration';
        infoText.textContent = 'Both Column 17 (ChannelOutletID) and Column 18 (AssigntoSalesRepEmail) will be disabled as leads are automatically assigned to the dealer admin.';
      }
      
      infoBox.style.display = 'block';
      updateNextButton();
    }
    
    
    function nextStep() {
      if (!validateCurrentStep()) {
        return;
      }
      
      // Save current step data
      saveCurrentStepData();
      
      // Determine next step
      let nextStepNum = currentStep + 1;
      
      // Skip credentials step for non-dealership organizations
      if (currentStep === 1 && config.organizationType !== 'DL') {
        nextStepNum = 3; // Skip to campaign dates
      }
      
      if (nextStepNum > totalSteps) {
        return;
      }
      
      showStep(nextStepNum);
    }
    
    function previousStep() {
      let prevStepNum = currentStep - 1;
      
      // Skip credentials step for non-dealership organizations when going back
      if (currentStep === 3 && config.organizationType !== 'DL') {
        prevStepNum = 1; // Go back to organization selection
      }
      
      if (prevStepNum < 1) {
        return;
      }
      
      showStep(prevStepNum);
    }
    
    function showStep(stepNum) {
      // Hide all steps
      document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
      });
      
      // Show current step
      document.getElementById(`step${stepNum}`).classList.add('active');
      currentStep = stepNum;
      
      // Update step-specific content
      if (stepNum === 4) {
        setupAssignmentStep();
      }
      
      updateProgress();
      updateButtons();
    }
    
    function setupAssignmentStep() {
      const storeOptions = document.getElementById('storeAssignmentOptions');
      const dealerOptions = document.getElementById('dealerAssignmentOptions');
      const description = document.getElementById('assignmentDescription');
      
      if (config.organizationType === 'DL') {
        // Dealership
        storeOptions.style.display = 'none';
        dealerOptions.style.display = 'block';
        description.textContent = 'Choose how leads should be assigned in your dealership:';
      } else {
        // Corporate Store or Mobile Klinik
        storeOptions.style.display = 'block';
        dealerOptions.style.display = 'none';
        description.textContent = 'Choose how leads should be assigned to your store employees:';
      }
    }
    
    function validateCurrentStep() {
      switch (currentStep) {
        case 1:
          return config.processingMode !== null;
        case 2:
          return config.organizationType !== null;
        case 3:
          // Only validate if we're on the credentials step (dealership)
          if (config.organizationType === 'DL') {
            const orgCode = document.getElementById('orgCode').value.trim();
            const authTokenName = document.getElementById('authTokenName').value.trim();
            const authTokenValue = document.getElementById('authTokenValue').value.trim();
            
            if (!orgCode || !authTokenName || !authTokenValue) {
              showStatus('Please fill in all credential fields', 'error');
              return false;
            }
          }
          return true;
        case 4:
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          
          if (!startDate || !endDate) {
            showStatus('Please select both start and end dates', 'error');
            return false;
          }
          
          if (new Date(startDate) >= new Date(endDate)) {
            showStatus('End date must be after start date', 'error');
            return false;
          }
          
          return true;
        case 5:
          return config.leadAssignment !== null;
        default:
          return true;
      }
    }
    
    function saveCurrentStepData() {
      switch (currentStep) {
        case 3:
          if (config.organizationType === 'DL') {
            config.orgCode = document.getElementById('orgCode').value.trim();
            config.authTokenName = document.getElementById('authTokenName').value.trim();
            config.authTokenValue = document.getElementById('authTokenValue').value.trim();
          }
          break;
        case 4:
          config.campaignStartDate = document.getElementById('startDate').value;
          config.campaignEndDate = document.getElementById('endDate').value;
          break;
      }
    }
    
    function updateProgress() {
      let progress;
      if (config.organizationType === 'DL') {
        // 5 steps for dealership
        progress = (currentStep / 5) * 100;
      } else {
        // 4 steps for others (skip credentials)
        let adjustedStep = currentStep;
        if (currentStep > 2) adjustedStep--; // Adjust for skipped step
        progress = (adjustedStep / 4) * 100;
      }
      
      document.getElementById('progressFill').style.width = progress + '%';
    }
    
    function updateButtons() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const saveBtn = document.getElementById('saveBtn');
      
      // Show/hide previous button
      prevBtn.style.display = currentStep > 1 ? 'inline-block' : 'none';
      
      // Determine if this is the last step
      const isLastStep = (config.organizationType === 'DL' && currentStep === 5) || 
                        (config.organizationType !== 'DL' && currentStep === 4);
      
      // Show/hide next and save buttons
      if (isLastStep) {
        nextBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
      } else {
        nextBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
      }
      
      updateNextButton();
    }
    
    function updateNextButton() {
      const nextBtn = document.getElementById('nextBtn');
      const saveBtn = document.getElementById('saveBtn');
      
      if (validateCurrentStep()) {
        nextBtn.disabled = false;
        saveBtn.disabled = false;
      } else {
        nextBtn.disabled = true;
        saveBtn.disabled = true;
      }
    }
    
    function saveConfiguration() {
      if (!validateCurrentStep()) {
        return;
      }
      
      // Save final step data
      saveCurrentStepData();
      
      showLoading(true);
      hideStatus();
      
      google.script.run
        .withSuccessHandler(onSaveSuccess)
        .withFailureHandler(onSaveFailure)
        .saveCompleteConfiguration(config);
    }
    
    function onSaveSuccess(result) {
      showLoading(false);
      
      if (result.success) {
        showStatus(result.message, 'success');
        setTimeout(() => {
          google.script.host.close();
        }, 2000);
      } else {
        showStatus(result.message, 'error');
      }
    }
    
    function onSaveFailure(error) {
      showLoading(false);
      showStatus('Error: ' + error.message, 'error');
    }
    
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
      document.getElementById('nextBtn').disabled = show;
      document.getElementById('saveBtn').disabled = show;
    }
    
    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = 'status ' + type;
      statusDiv.style.display = 'block';
    }
    
    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }
  </script>
</body>
</html>
